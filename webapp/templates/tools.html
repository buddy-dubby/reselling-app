{% extends "base.html" %}

{% block title %}Tools{% endblock %}

{% block content %}
<h2 style="margin-bottom: 24px;">üõ†Ô∏è Tools</h2>

<!-- Background Removal Tool -->
<div class="card">
    <h3 style="margin-bottom: 16px;">‚ú® Background Remover</h3>
    <p style="color: #888; margin-bottom: 20px;">Upload any product photo to remove its background instantly. Get both transparent PNG and white background JPG versions.</p>
    
    <div id="dropZone" style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;">
        <div style="font-size: 3em; margin-bottom: 10px;">üì∏</div>
        <div style="margin-bottom: 10px;">Drop an image here or click to upload</div>
        <div style="color: #888; font-size: 0.85em;">Supports JPG, PNG, WebP</div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
    </div>
    
    <div id="preview" style="display: none; margin-top: 20px;">
        <h4 style="margin-bottom: 12px;">Original</h4>
        <img id="previewImg" style="max-width: 300px; max-height: 300px; border-radius: 8px;">
        <div style="margin-top: 15px;">
            <button id="processBtn" class="btn btn-primary" onclick="processImage()">‚ú® Remove Background</button>
        </div>
    </div>
    
    <div id="results" style="display: none; margin-top: 30px;">
        <h4 style="margin-bottom: 16px;">Results</h4>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <img id="whiteResult" style="max-width: 250px; max-height: 250px; border-radius: 8px; border: 2px solid #4ade80;">
                <div style="margin-top: 8px; color: #888;">White Background</div>
                <a id="whiteDownload" class="btn" style="margin-top: 8px; display: inline-block;" download>‚¨áÔ∏è Download JPG</a>
            </div>
            <div style="text-align: center;">
                <img id="transparentResult" style="max-width: 250px; max-height: 250px; border-radius: 8px; background: repeating-conic-gradient(#333 0% 25%, #444 0% 50%) 50% / 20px 20px;">
                <div style="margin-top: 8px; color: #888;">Transparent</div>
                <a id="transparentDownload" class="btn" style="margin-top: 8px; display: inline-block;" download>‚¨áÔ∏è Download PNG</a>
            </div>
        </div>
    </div>
</div>

<!-- Description Generator Tool -->
<div class="card" style="margin-top: 20px;">
    <h3 style="margin-bottom: 16px;">üìù Description Generator</h3>
    <p style="color: #888; margin-bottom: 20px;">Generate platform-optimized listing descriptions. Fill in the details and get ready-to-paste descriptions for Poshmark, Depop, eBay, Mercari, and Â∞èÁ∫¢‰π¶!</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div>
            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Item Name *</label>
            <input type="text" id="descName" placeholder="e.g., Platform Heel Boots" style="width: 100%;">
        </div>
        <div>
            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Brand</label>
            <input type="text" id="descBrand" placeholder="e.g., Dr. Martens" style="width: 100%;">
        </div>
        <div>
            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Category</label>
            <select id="descCategory" style="width: 100%;">
                <option value="">Select...</option>
                <option value="tops">Tops</option>
                <option value="bottoms">Bottoms</option>
                <option value="dresses">Dresses</option>
                <option value="outerwear">Outerwear</option>
                <option value="shoes">Shoes</option>
                <option value="bags">Bags</option>
                <option value="accessories">Accessories</option>
            </select>
        </div>
        <div>
            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Condition</label>
            <select id="descCondition" style="width: 100%;">
                <option value="new">New with tags</option>
                <option value="excellent">Excellent (like new)</option>
                <option value="good" selected>Good (gently used)</option>
                <option value="fair">Fair (visible wear)</option>
            </select>
        </div>
        <div>
            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Color</label>
            <input type="text" id="descColor" placeholder="e.g., Black" style="width: 100%;">
        </div>
        <div>
            <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Size</label>
            <input type="text" id="descSize" placeholder="e.g., US 8, M, 28" style="width: 100%;">
        </div>
    </div>
    
    <div style="margin-bottom: 20px;">
        <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Measurements (optional)</label>
        <input type="text" id="descMeasurements" placeholder="e.g., Pit to pit: 20in, Length: 26in" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 20px;">
        <label style="display: block; color: #888; margin-bottom: 5px; font-size: 0.85em;">Extra Notes (optional)</label>
        <textarea id="descNotes" placeholder="Any special details, flaws, or selling points..." style="width: 100%; height: 60px; resize: vertical;"></textarea>
    </div>
    
    <button class="btn btn-primary" onclick="generateDescriptions()">üìù Generate Descriptions</button>
    
    <div id="descriptionResults" style="display: none; margin-top: 25px;">
        <h4 style="margin-bottom: 15px;">Generated Descriptions</h4>
        <div id="descTabs" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;"></div>
        <div id="descContent" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; position: relative;">
            <pre id="descText" style="white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit;"></pre>
            <button onclick="copyDescription()" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); cursor: pointer;">üìã Copy</button>
        </div>
    </div>
</div>

<!-- Price Checker Tool -->
<div class="card" style="margin-top: 20px;">
    <h3 style="margin-bottom: 16px;">üîç Quick Price Check</h3>
    <p style="color: #888; margin-bottom: 20px;">Look up real market prices from sold listings on eBay and Poshmark.</p>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <input type="text" id="priceQuery" placeholder="e.g., Nike Air Max 90 white" style="flex: 1; min-width: 200px;">
        <button class="btn btn-primary" onclick="quickPriceCheck()">Check Prices</button>
    </div>
    
    <div id="quickPriceResults" style="margin-top: 20px; display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
let selectedFile = null;

// Click to upload
dropZone.addEventListener('click', () => fileInput.click());

// File selected
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

// Drag and drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#667eea';
    dropZone.style.background = 'rgba(102, 126, 234, 0.1)';
});

dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = 'rgba(255,255,255,0.2)';
    dropZone.style.background = 'transparent';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'rgba(255,255,255,0.2)';
    dropZone.style.background = 'transparent';
    
    if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
    }
});

function handleFile(file) {
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    selectedFile = file;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImg.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('results').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

async function processImage() {
    if (!selectedFile) return;
    
    const btn = document.getElementById('processBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Processing... (may take 10-30s)';
    
    const formData = new FormData();
    formData.append('image', selectedFile);
    
    try {
        const response = await fetch('/api/remove-background', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('whiteResult').src = data.white_bg.url;
            document.getElementById('transparentResult').src = data.transparent.url;
            document.getElementById('whiteDownload').href = data.white_bg.url;
            document.getElementById('transparentDownload').href = data.transparent.url;
            document.getElementById('results').style.display = 'block';
            
            btn.textContent = '‚úÖ Done! Upload another?';
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        alert('Error processing image: ' + error.message);
        btn.textContent = '‚ú® Remove Background';
    }
    
    btn.disabled = false;
}

// Description Generator
let generatedDescriptions = {};
let currentPlatform = 'poshmark';

async function generateDescriptions() {
    const name = document.getElementById('descName').value.trim();
    if (!name) {
        alert('Please enter an item name');
        return;
    }
    
    const data = {
        name: name,
        brand: document.getElementById('descBrand').value.trim(),
        category: document.getElementById('descCategory').value,
        condition: document.getElementById('descCondition').value,
        color: document.getElementById('descColor').value.trim(),
        size: document.getElementById('descSize').value.trim(),
        measurements: document.getElementById('descMeasurements').value.trim(),
        notes: document.getElementById('descNotes').value.trim()
    };
    
    try {
        const response = await fetch('/api/generate-description', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        generatedDescriptions = await response.json();
        
        // Create tabs
        const platforms = [
            { id: 'poshmark', label: 'üõçÔ∏è Poshmark' },
            { id: 'depop', label: 'üëï Depop' },
            { id: 'mercari', label: 'üì¶ Mercari' },
            { id: 'ebay', label: 'üè∑Ô∏è eBay' },
            { id: 'xiaohongshu', label: 'üìï Â∞èÁ∫¢‰π¶' }
        ];
        
        const tabsHtml = platforms.map(p => 
            `<button class="btn ${p.id === currentPlatform ? 'btn-primary' : ''}" 
                     onclick="showPlatform('${p.id}')" 
                     id="tab-${p.id}">${p.label}</button>`
        ).join('');
        
        document.getElementById('descTabs').innerHTML = tabsHtml;
        document.getElementById('descText').textContent = generatedDescriptions[currentPlatform];
        document.getElementById('descriptionResults').style.display = 'block';
        
    } catch (error) {
        alert('Error generating descriptions: ' + error.message);
    }
}

function showPlatform(platform) {
    currentPlatform = platform;
    document.getElementById('descText').textContent = generatedDescriptions[platform];
    
    // Update tab styles
    document.querySelectorAll('#descTabs button').forEach(btn => {
        btn.classList.remove('btn-primary');
    });
    document.getElementById('tab-' + platform).classList.add('btn-primary');
}

function copyDescription() {
    const text = document.getElementById('descText').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = 'üìã Copy', 2000);
    });
}

async function quickPriceCheck() {
    const query = document.getElementById('priceQuery').value.trim();
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    const results = document.getElementById('quickPriceResults');
    results.style.display = 'block';
    results.innerHTML = '<div style="color: #888;">üîç Searching sold listings...</div>';
    
    try {
        const response = await fetch('/api/price-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        });
        
        const data = await response.json();
        
        results.innerHTML = `
            <div class="card" style="margin: 0; background: rgba(102, 126, 234, 0.1);">
                <h4 style="margin-bottom: 15px;">"${query}"</h4>
                <div style="display: flex; justify-content: space-around; text-align: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <div style="color: #fbbf24; font-size: 1.5em; font-weight: bold;">$${data.recommendation.quick_sale}</div>
                        <div style="color: #888;">Quick Sale</div>
                    </div>
                    <div>
                        <div style="color: #4ade80; font-size: 1.5em; font-weight: bold;">$${data.recommendation.fair_price}</div>
                        <div style="color: #888;">Fair Price</div>
                    </div>
                    <div>
                        <div style="color: #a78bfa; font-size: 1.5em; font-weight: bold;">$${data.recommendation.max_value}</div>
                        <div style="color: #888;">Max Value</div>
                    </div>
                </div>
                <div style="margin-top: 15px; color: #888; font-size: 0.85em; text-align: center;">${data.tip}</div>
            </div>
        `;
    } catch (error) {
        results.innerHTML = '<div style="color: #f87171;">Error checking prices</div>';
    }
}
</script>
{% endblock %}
